---
import MainHead from '../components/MainHead.astro';
import Nav from '../components/Nav.astro';
import Footer from '../components/Footer.astro';
import { getAlternatePath, type Locale } from '../i18n';

interface Props {
	locale?: Locale;
	title?: string | undefined;
	description?: string | undefined;
	keywords?: string | undefined;
	ogImage?: string | undefined;
	structuredData?: object | undefined;
	noIndex?: boolean;
}

const {
	locale = 'fr',
	title,
	description,
	keywords,
	ogImage,
	structuredData,
	noIndex = false
} = Astro.props;

const currentPath = Astro.url.pathname;
const alternatePath = getAlternatePath(currentPath, locale);
const siteUrl = Astro.site?.toString().replace(/\/$/, '') ?? 'https://la3emedim.fr';
---

<html lang={locale === 'en' ? 'en-GB' : 'fr-FR'}>
	<head>
		<MainHead
			title={title}
			description={description}
			keywords={keywords}
			ogImage={ogImage}
			structuredData={structuredData}
			locale={locale}
			noIndex={noIndex}
		/>
		<link rel="sitemap" href="/sitemap-index.xml" />
		<link
			rel="alternate"
			type="application/rss+xml"
			title={locale === 'fr' ? 'La 3ème dimension' : 'La 3ème dimension (English)'}
			href={new URL(locale === 'fr' ? 'rss.xml' : 'en/rss.xml', Astro.site)}
		/>
		<link rel="alternate" hreflang="fr" href={`${siteUrl}${locale === 'fr' ? currentPath : alternatePath}`} />
		<link rel="alternate" hreflang="en" href={`${siteUrl}${locale === 'en' ? currentPath : alternatePath}`} />
		<link rel="alternate" hreflang="x-default" href={`${siteUrl}${locale === 'fr' ? currentPath : alternatePath}`} />
	</head>
	<body>
		<div class="stack backgrounds">
			<Nav locale={locale} />
			<slot />
			<Footer locale={locale} />
		</div>

		<script>
			// Add “loaded” class once the document has completely loaded.
			addEventListener('load', () => document.documentElement.classList.add('loaded'));

		// Add target="_blank" to all external links site-wide
		document.addEventListener('DOMContentLoaded', () => {
			const allLinks = document.querySelectorAll('a[href]');
			allLinks.forEach((link) => {
				const href = link.getAttribute('href');
				// Only process http/https links (exclude mailto:, tel:, #, /, etc.)
				if (href && (href.startsWith('http://') || href.startsWith('https://'))) {
					// Only add target if it's not already set
					if (!link.hasAttribute('target')) {
						link.setAttribute('target', '_blank');
						link.setAttribute('rel', 'noopener noreferrer');
					}
				}
			});
		});
		</script>

		<style>
			:root {
				--_placeholder-bg: linear-gradient(transparent, transparent);
				--bg-image-main: url('/assets/backgrounds/bg-main-light-800w.jpg');
				--bg-image-main-curves: url('/assets/backgrounds/bg-main-light.svg');
				--bg-image-subtle-1: var(--_placeholder-bg);
				--bg-image-subtle-2: var(--_placeholder-bg);
				--bg-image-footer: var(--_placeholder-bg);
				--bg-svg-blend-mode: overlay;
				--bg-blend-mode: darken;
				--bg-image-aspect-ratio: 2.25;
				--bg-scale: 1.68;
				--bg-aspect-ratio: calc(var(--bg-image-aspect-ratio) / var(--bg-scale));
				--bg-gradient-size: calc(var(--bg-scale) * 100%);
			}

			:root.theme-dark {
				--bg-image-main: url('/assets/backgrounds/bg-main-dark-800w.jpg');
				--bg-image-main-curves: url('/assets/backgrounds/bg-main-dark.svg');
				--bg-svg-blend-mode: darken;
				--bg-blend-mode: lighten;
			}

			/* These backgrounds are displayed below the fold, so we lazy load them
			   once the `.loaded` class has been set.  */
			:root.loaded {
				--bg-image-subtle-1: url('/assets/backgrounds/bg-subtle-1-light-800w.jpg');
				--bg-image-subtle-2: url('/assets/backgrounds/bg-subtle-2-light-800w.jpg');
				--bg-image-footer: url('/assets/backgrounds/bg-footer-light-800w.jpg');
			}
			:root.loaded.theme-dark {
				--bg-image-subtle-1: url('/assets/backgrounds/bg-subtle-1-dark-800w.jpg');
				--bg-image-subtle-2: url('/assets/backgrounds/bg-subtle-2-dark-800w.jpg');
				--bg-image-footer: url('/assets/backgrounds/bg-footer-dark-800w.jpg');
			}

			@media (min-width: 50em) {
				:root {
					--bg-scale: 1;
					--bg-image-main: url('/assets/backgrounds/bg-main-light-1440w.jpg');
				}
				:root.theme-dark {
					--bg-image-main: url('/assets/backgrounds/bg-main-dark-1440w.jpg');
				}

				:root.loaded {
					--bg-image-subtle-1: url('/assets/backgrounds/bg-subtle-1-light-1440w.jpg');
					--bg-image-subtle-2: url('/assets/backgrounds/bg-subtle-2-light-1440w.jpg');
					--bg-image-footer: url('/assets/backgrounds/bg-footer-light-1440w.jpg');
				}
				:root.loaded.theme-dark {
					--bg-image-subtle-1: url('/assets/backgrounds/bg-subtle-1-dark-1440w.jpg');
					--bg-image-subtle-2: url('/assets/backgrounds/bg-subtle-2-dark-1440w.jpg');
					--bg-image-footer: url('/assets/backgrounds/bg-footer-dark-1440w.jpg');
				}
			}

			.backgrounds {
				min-height: 100%;
				isolation: isolate;
				background:
					/*noise*/
					url('/assets/backgrounds/noise.png') top center/220px repeat,
					/*footer*/ var(--bg-image-footer) bottom center/var(--bg-gradient-size) no-repeat,
					/*header1*/ var(--bg-image-main-curves) top center/var(--bg-gradient-size) no-repeat,
					/*header2*/ var(--bg-image-main) top center/var(--bg-gradient-size) no-repeat,
					/*base*/ var(--gray-999);
				background-blend-mode: /*noise*/
					overlay,
					/*footer*/ var(--bg-blend-mode),
					/*header1*/ var(--bg-svg-blend-mode),
					/*header2*/ normal,
					/*base*/ normal;
			}
			@media (forced-colors: active) {
				/* Deactivate custom backgrounds for high contrast users. */
				.backgrounds {
					background: none;
					background-blend-mode: none;
					--bg-gradient-size: none;
				}
			}
		</style>
	</body>
</html>
