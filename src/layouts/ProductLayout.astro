---
import BaseLayout from './BaseLayout.astro';
import ContactCTA from '../components/ContactCTA.astro';
import ProductHero from '../components/ProductHero.astro';
import VideoShowcase from '../components/VideoShowcase.astro';
import Gallery from '../components/Gallery.astro';
import FeatureGrid from '../components/FeatureGrid.astro';
import SpecsTable from '../components/SpecsTable.astro';
import PricingSection from '../components/PricingSection.astro';
import ProductNavigation from '../components/ProductNavigation.astro';
import Lightbox from '../components/Lightbox.astro';
import Breadcrumbs from '../components/Breadcrumbs.astro';
import RelatedProducts from '../components/RelatedProducts.astro';
import { useTranslations, localePath, type Locale } from '../i18n';

export interface ProductConfig {
  seoTitle: string;
  seoDescription: string;
  seoKeywords: string;
  ogImage?: string;
  structuredData?: any;
  draft?: boolean;
  sections: SectionConfig[];
  navigationItems?: NavigationItem[];
  showContactCTA?: boolean;
  showNavigation?: boolean;
  showLightbox?: boolean;
  locale?: Locale;
}

export interface SectionConfig {
  type: 'hero' | 'gallery' | 'video' | 'features' | 'specs' | 'pricing' | 'custom';
  id?: string;
  data: any;
  customComponent?: any;
}

export interface NavigationItem {
  id: string;
  label: string;
}

const {
  seoTitle,
  seoDescription,
  seoKeywords,
  ogImage,
  structuredData,
  draft,
  sections,
  navigationItems = [],
  showContactCTA = true,
  showNavigation = true,
  showLightbox = true,
  locale = 'fr'
} = Astro.props as ProductConfig;

const t = useTranslations(locale);

const sectionComponents = {
  hero: ProductHero,
  gallery: Gallery,
  video: VideoShowcase,
  features: FeatureGrid,
  specs: SpecsTable,
  pricing: PricingSection
};

// Get product name from first hero section
const heroSection = sections.find(s => s.type === 'hero');
const productName = heroSection?.data?.title || 'Produit';

// Get product slug from URL
const urlPath = Astro.url.pathname;
const productSlug = urlPath.split('/').filter(Boolean).pop() || '';

// Get category from structured data
const category = structuredData?.category;

// Build breadcrumbs
const breadcrumbItems = [
  { label: locale === 'fr' ? 'Accueil' : 'Home', href: localePath('/', locale) },
  { label: locale === 'fr' ? 'Boutique' : 'Shop', href: localePath('/shop/', locale) },
  { label: productName, href: Astro.url.pathname }
];
---

<BaseLayout
  locale={locale}
  title={seoTitle}
  description={seoDescription}
  keywords={seoKeywords}
  ogImage={ogImage}
  structuredData={structuredData}
>
  {import.meta.env.DEV && draft && (
    <div class="draft-banner">
      <div class="wrapper">
        <span class="draft-text">ðŸš§ {t.product.draftBanner}</span>
      </div>
    </div>
  )}
  <div class="breadcrumb-wrapper">
    <Breadcrumbs items={breadcrumbItems} locale={locale} />
  </div>
  {sections.map((section) => {
    const Component = section.type === 'custom' ? section.customComponent : sectionComponents[section.type];

    if (!Component && section.type !== 'custom') {
      console.warn(`Unknown section type: ${section.type}`);
      return null;
    }

    const propsWithLocale = section.type === 'pricing'
      ? { ...section.data, locale }
      : section.data;

    return (
      <section id={section.id || `section-${section.type}`}>
        <Component {...propsWithLocale} />
      </section>
    );
  })}

  <RelatedProducts
    currentProductId={productSlug}
    category={category}
    maxProducts={3}
    locale={locale}
  />

  {showContactCTA && <ContactCTA locale={locale} />}

  {showNavigation && navigationItems.length > 0 && (
    <ProductNavigation items={navigationItems} />
  )}

  {showLightbox && <Lightbox locale={locale} />}
</BaseLayout>

<style>
  .draft-banner {
    background: linear-gradient(135deg, #ff6b35, #f7931e);
    color: white;
    padding: 0.75rem 0;
    text-align: center;
    position: sticky;
    top: 0;
    z-index: 1000;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  }

  .draft-text {
    font-weight: 600;
    font-size: var(--text-sm);
    letter-spacing: 0.025em;
  }

  .wrapper {
    max-width: 65ch;
    margin-inline: auto;
    padding-inline: 1.5rem;
  }

  .breadcrumb-wrapper {
    max-width: 1400px;
    margin-inline: auto;
    padding-inline: 2rem;
  }

  @media (max-width: 50em) {
    .breadcrumb-wrapper {
      padding-inline: 1rem;
    }
  }
</style>